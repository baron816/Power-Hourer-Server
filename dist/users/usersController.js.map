{"version":3,"sources":["../../src/users/usersController.js"],"names":["userPlaylists","findOrCreateUser","idParam","req","res","_id","user","find","owner","then","playlistsData","playlists","map","playlistId","title","thumbnail","exposed","json","next","auth","client","OAuth2","process","env","CLIENT_ID","idToken","headers","authorization","verifyIdToken","err","login","payload","getPayload","googleId","findOne","newUser","save","usr","id","findById","status"],"mappings":"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","file":"usersController.js","sourcesContent":["import User from './userModel';\nimport Playlist from '../playlists/playlistModel';\nimport GoogleAuth from 'google-auth-library';\n\nexport function userPlaylists(req, res) {\n  const {_id} = req.user;\n\n  Playlist\n  .find({owner: _id})\n  .then(function(playlistsData) {\n    const playlists = playlistsData.map(({_id, owner, playlistId, title, thumbnail, exposed}) => ({_id, owner, playlistId, title, thumbnail, exposed}));\n    res.json({_id, playlists} || {});\n  });\n}\n\nexport function findOrCreateUser(req, res, next) {\n  const auth = new GoogleAuth;\n  const client = new auth.OAuth2(process.env.CLIENT_ID);\n\n  const {authorization: idToken} = req.headers;\n\n  client.verifyIdToken(\n    idToken,\n    process.env.CLIENT_ID,\n    function (err, login) {\n      if (err) {\n        next(err);\n      } else {\n        const payload = login.getPayload();\n        const googleId = payload['sub'];\n\n        User.findOne({googleId})\n        .then(function (user) {\n          if (user) {\n            Playlist.find({owner: user._id})\n            .then(function(playlistsData) {\n              const playlists = playlistsData.map(({_id, owner, playlistId, title, thumbnail, exposed}) => ({_id, owner, playlistId, title, thumbnail, exposed}));\n              res.json({_id: user._id, playlists} || {});\n            });\n          } else {\n            const newUser = new User({googleId});\n\n            newUser.save(function (err, usr) {\n              if (err) {\n                next(err);\n              } else {\n                res.json({_id: usr._id, playlists: []});\n              }\n            });\n          }\n        });\n      }\n    }\n  );\n\n}\n\nexport function idParam(req, res, next, id) {\n  User\n  .findById(id)\n  .then(function(user) {\n    if (user) {\n      req.user = user;\n      next();\n    } else {\n      res.status(404).json({err: 'Not found'});\n    }\n  }, function(err) {\n    next(err);\n  });\n}\n"]}